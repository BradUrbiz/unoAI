<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>unoAI - Play</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hand {
            position: fixed;
            left: 50%;
            bottom: 0;
            right: auto;
                transform: translateX(-50%);
                margin: 0;
            display: flex;
            gap: 0.5rem;
            padding: 0;
            z-index: 10;
        }
        .hand img {
            height: 100px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px #2225;
            background: #fff8;
        }
        .center-table {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .center-table img {
            max-width: 60vw;
            max-height: 60vh;
            border-radius: 0;
            box-shadow: none;
        }
        .character-img {
            position: fixed;
            top: 0;
            left: 0;
            margin: 1.2rem 0 0 1.2rem;
            height: 120px;
            width: auto;
            z-index: 20;
        }
        .restart-btn {
            position: fixed;
            top: 1.2rem;
            right: 1.2rem;
            z-index: 30;
            padding: 0.7rem 1.4rem;
            font-size: 1.1rem;
            background: #2ecc40;
            color: #fff;
            border: none;
            border-radius: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 8px #2223;
            transition: background 0.2s, transform 0.2s;
        }
        .restart-btn:hover {
            background: #27ae38;
            transform: scale(1.05);
        }
        .restart-btn#restart-btn {
            position: fixed;
            top: 1.2rem;
            right: 1.2rem;
            z-index: 30;
            padding: 0.7rem 1.4rem;
            font-size: 1.1rem;
            background: #2ecc40;
            color: #fff;
            border: none;
            border-radius: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 8px #2223;
            transition: background 0.2s, transform 0.2s;
        }
        .restart-btn#restart-btn:hover {
            background: #27ae38;
            transform: scale(1.05);
        }
        .middle-cards {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
        }
        .top-card {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .top-card img {
            height: 120px;
            width: auto;
            box-shadow: 0 2px 8px #2225;
            border-radius: 8px;
            background: #fff8;
        }
        .deck-card img {
            height: 120px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px #2225;
            background: #fff8;
            cursor: pointer;
            transition: transform 0.15s;
        }
        .deck-card img:hover {
            transform: scale(1.08);
        }
        .opponent-hand {
            position: fixed;
            left: 50%;
            top: 0;
            right: auto;
            transform: translateX(-50%);
            margin: 0;
            display: flex;
            gap: 0.5rem;
            padding: 0;
            z-index: 10;
        }
        .opponent-hand img {
            height: 100px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px #2225;
            background: #fff8;
        }
        .opponent-middle-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateY(-80px);
            z-index: 6;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .opponent-middle-card img {
            height: 120px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px #2225;
            background: #fff8;
        }
        .status-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, 80px);
            z-index: 50;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-size: 1.3rem;
            display: none;
            text-align: center;
        }
        .status-msg.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="center-table">
        <img src="../Tables/table_green.png.png" alt="Table Green" />
    </div>
    <div class="hand" id="player-hand"></div>
    <img id="character-img" class="character-img" src="" alt="Character" />
    <button class="restart-btn" id="restart-btn">Restart Game</button>
    <div class="middle-cards">
        <div class="deck-card">
            <img id="deck-draw" src="../Uno/individual/card back/card_back.png" alt="Card Back (click to draw)" />
        </div>
        <div class="top-card" id="top-card"></div>
    </div>
    <div class="opponent-hand" id="opponent-hand"></div>
    <div class="opponent-middle-card" id="opponent-middle-card"></div>
    <div class="status-msg" id="status-msg"></div>
    <audio id="bg-music" src="../em.mp3" autoplay loop></audio>
    <script>
        const bgMusic = document.getElementById('bg-music');
        bgMusic.volume = 0.4;
        document.addEventListener('click', () => { bgMusic.play(); }, { once: true });
        function showStatus(msg) {
            const el = document.getElementById('status-msg');
            el.textContent = msg;
            el.classList.add('show');
        }
        function hideStatus() {
            document.getElementById('status-msg').classList.remove('show');
        }
        let currentHand = [];
        let opponentHand = [];
        let currentTopCard = null;
        let currentColor = null;
        let myTurn = true;

        document.getElementById('deck-draw').onclick = function() {
            if (!myTurn) return;
            const hasPlayable = currentHand.some(c => canPlay(c, currentTopCard, currentColor));
            if (hasPlayable) {
                showStatus('You have a playable card! Pick one.');
                setTimeout(hideStatus, 1500);
                return;
            }
            const drawn = generateRandomCards(1);
            currentHand.push(...drawn);
            renderHand();
            showStatus('You drew a card! My turn now.');
            myTurn = false;
            setTimeout(() => {
                hideStatus();
                showStatus('Hmm... let me think ðŸ¤”');
                setTimeout(opponentTurn, 1000);
            }, 1200);
        };

        function canPlay(card, topCard, color) {
            return (
                card.color === 'wild' ||
                card.color === color ||
                card.value === topCard.value
            );
        }

        function generateRandomCards(count) {
            const colors = ['red', 'yellow', 'green', 'blue'];
            const values = ['0','1','2','3','4','5','6','7','8','9','skip','reverse','draw2'];
            const cards = [];
            for (let i = 0; i < count; i++) {
                const c = colors[Math.floor(Math.random() * colors.length)];
                const v = values[Math.floor(Math.random() * values.length)];
                cards.push({ color: c, value: v });
            }
            return cards;
        }

        function getCardImage(card) {
            if (card.color === 'wild') {
                if (card.value === 'wild4') {
                    return '../Uno/individual/wild/4_plus.png';
                } else {
                    return '../Uno/individual/wild/wild_card.png';
                }
            }
            let value = card.value;
            if (value === 'skip') value = 'block';
            else if (value === 'reverse') value = 'inverse';
            else if (value === 'draw2') value = '2plus';
            return `../Uno/individual/${card.color}/${value}_${card.color}.png`;
        }

        function renderHand() {
            const handDiv = document.getElementById('player-hand');
            handDiv.innerHTML = '';

            currentHand.forEach((card, idx) => {
                const label = document.createElement('label');
                label.classList.add('card-option');

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'selected-card';
                radio.value = idx;

                const img = document.createElement('img');
                img.src = getCardImage(card);
                img.alt = `${card.color} ${card.value}`;

                label.appendChild(radio);
                label.appendChild(img);
                handDiv.appendChild(label);
            });
        }

        function renderOpponentHand() {
            const oppDiv = document.getElementById('opponent-hand');
            oppDiv.innerHTML = '';
            for (let i = 0; i < opponentHand.length; i++) {
                const img = document.createElement('img');
                img.src = '../Uno/individual/card back/card_back.png';
                img.alt = 'Opponent Card Back';
                oppDiv.appendChild(img);
            }
        }

        function renderTopCard() {
            const topDiv = document.getElementById('top-card');
            topDiv.innerHTML = '';
            if (!currentTopCard) return;
            const img = document.createElement('img');
            img.src = getCardImage(currentTopCard);
            img.alt = `${currentTopCard.color} ${currentTopCard.value}`;
            img.style.cursor = 'pointer';
            img.onclick = function() {
                if (!myTurn) return;
                const selected = document.querySelector('input[name="selected-card"]:checked');
                if (!selected) return;
                const idx = parseInt(selected.value);
                const playedCard = currentHand[idx];
                if (canPlay(playedCard, currentTopCard, currentColor)) {
                    currentHand.splice(idx, 1);
                    currentTopCard = playedCard;
                    currentColor = playedCard.color === 'wild' ? currentColor : playedCard.color;
                    renderHand();
                    renderTopCard();
                    if (currentHand.length === 0) {
                        setTimeout(() => alert('You win! ðŸŽ‰'), 300);
                        return;
                    }
                    if (playedCard.value === 'skip' || playedCard.value === 'reverse') {
                        showStatus('Aw man, my turn got skipped! â­ï¸');
                        setTimeout(() => { hideStatus(); myTurn = true; }, 1200);
                    } else if (playedCard.value === 'draw2') {
                        const drawn = generateRandomCards(2);
                        opponentHand.push(...drawn);
                        renderOpponentHand();
                        showStatus('Nooo I have to draw 2! +2 â­ï¸');
                        setTimeout(() => { hideStatus(); myTurn = true; }, 1500);
                    } else if (playedCard.value === 'wild4') {
                        const drawn = generateRandomCards(4);
                        opponentHand.push(...drawn);
                        renderOpponentHand();
                        showStatus('Are you serious?! I draw 4?! +4 â­ï¸');
                        setTimeout(() => { hideStatus(); myTurn = true; }, 1500);
                    } else {
                        myTurn = false;
                        showStatus('Hmm... let me think ðŸ¤”');
                        setTimeout(opponentTurn, 1000);
                    }
                } else {
                    showStatus('Can\'t play that card! Click the deck to draw.');
                    setTimeout(hideStatus, 2000);
                }
            };
            topDiv.appendChild(img);
        }

        async function opponentTurn() {
            showStatus('Hmm... let me think ðŸ¤”');
            try {
                const response = await fetch('http://localhost:5000/ai-move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        hand: opponentHand,
                        top_card: currentTopCard,
                        current_color: currentColor
                    })
                });
                const move = await response.json();

                if (move.action === 'draw') {
                    const drawn = generateRandomCards(1);
                    opponentHand.push(...drawn);
                    renderOpponentHand();
                    showStatus('Hmm nothing works... let me draw ðŸ˜”');
                    setTimeout(() => { hideStatus(); myTurn = true; }, 1500);
                    return;
                }

                const idx = opponentHand.findIndex(c =>
                    c.color === move.color && c.value === move.value
                );

                if (idx !== -1 && canPlay(opponentHand[idx], currentTopCard, currentColor)) {
                    const playedCard = opponentHand.splice(idx, 1)[0];
                    showStatus(`Ooh how about this! ${playedCard.color.toUpperCase()} ${playedCard.value.toUpperCase()} ðŸ˜`);
                    currentTopCard = playedCard;
                    currentColor = playedCard.color === 'wild' ? currentColor : playedCard.color;
                    renderOpponentHand();
                    setTimeout(() => {
                        renderTopCard();
                        if (opponentHand.length === 0) {
                            hideStatus();
                            setTimeout(() => alert('Opponent wins! ðŸ˜¢'), 300);
                            return;
                        }
                        if (playedCard.value === 'skip' || playedCard.value === 'reverse') {
                            showStatus('Haha, skipped! My turn again â­ï¸');
                            setTimeout(() => opponentTurn(), 1500);
                        } else if (playedCard.value === 'draw2') {
                            const drawn = generateRandomCards(2);
                            currentHand.push(...drawn);
                            renderHand();
                            showStatus('Take these 2 cards! +2 My turn again ðŸ˜ˆ');
                            setTimeout(() => opponentTurn(), 2000);
                        } else if (playedCard.value === 'wild4') {
                            const drawn = generateRandomCards(4);
                            currentHand.push(...drawn);
                            renderHand();
                            showStatus('Eat these 4 cards! +4 My turn again ðŸ˜ˆ');
                            setTimeout(() => opponentTurn(), 2000);
                        } else {
                            hideStatus();
                            myTurn = true;
                        }
                    }, 1500);
                    return;
                } else {
                    const drawn = generateRandomCards(1);
                    opponentHand.push(...drawn);
                    renderOpponentHand();
                    showStatus('I got nothing... drawing a card ðŸ˜”');
                    setTimeout(() => { hideStatus(); myTurn = true; }, 1500);
                    return;
                }
            } catch (err) {
                showStatus('Ugh, my brain glitched... your turn.');
                setTimeout(() => { hideStatus(); myTurn = true; }, 2000);
            }
        }

        function getRandomCard() {
            const colors = ['red', 'yellow', 'green', 'blue'];
            const values = ['0','1','2','3','4','5','6','7','8','9','skip','reverse','draw2'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            const value = values[Math.floor(Math.random() * values.length)];
            return { color, value };
        }

        Promise.all([
            fetch('../hand.json').then(r => r.json()),
            fetch('../opponent_hand.json').then(r => r.json()).catch(() => {
                const colors = ['red','yellow','green','blue'];
                const values = ['0','1','2','3','4','5','6','7','8','9','skip','reverse','draw2'];
                const hand = [];
                for (let i = 0; i < 7; i++) {
                    const c = colors[Math.floor(Math.random() * colors.length)];
                    const v = values[Math.floor(Math.random() * values.length)];
                    hand.push({ color: c, value: v });
                }
                return hand;
            })
        ]).then(([hand, oppHand]) => {
            currentHand = hand;
            opponentHand = oppHand;
            currentTopCard = getRandomCard();
            currentColor = currentTopCard.color;
            renderHand();
            renderOpponentHand();
            renderTopCard();
        });

        function setRandomCharacter() {
            const n = Math.floor(Math.random() * 13) + 1;
            const img = document.getElementById('character-img');
            img.src = `../Characters/char_${n}.png`;
            img.alt = `Character ${n}`;
        }
        setRandomCharacter();

        document.getElementById('restart-btn').onclick = function() {
            fetch('http://localhost:3001/reshuffle', { method: 'POST' })
                .then(() => Promise.all([
                    fetch('../hand.json').then(r => r.json()),
                    fetch('../opponent_hand.json').then(r => r.json())
                ]))
                .then(([hand, oppHand]) => {
                    currentHand = hand;
                    opponentHand = oppHand;
                    currentTopCard = getRandomCard();
                    currentColor = currentTopCard.color;
                    myTurn = true;
                    renderHand();
                    renderOpponentHand();
                    renderTopCard();
                });
            setRandomCharacter();
        };
    </script>
</body>
</html>
